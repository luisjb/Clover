<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clover Cloud Pay Display - Emparejamiento</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .nav a:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .config-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #FF9800; }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navegaci√≥n entre p√°ginas -->
        <div class="nav">
            <a href="index.html">üîê OAuth Setup</a>
            <a href="pairing.html">üîó Device Pairing</a>
            <a href="callback.html">üìû OAuth Callback</a>
        </div>
        
        <h1>üîó Cloud Pay Display Pairing</h1>
        
        <div class="step">
            <h3>üìã Configuraci√≥n autom√°tica</h3>
            <p>Usando la configuraci√≥n de tu app existente:</p>
            <div class="config-box" id="autoConfig">
                <strong>Client ID:</strong> BQA69R3NPK6MC<br>
                <strong>Merchant ID:</strong> 20562DRSEE6T1<br>
                <strong>Device Serial:</strong> C047LG44442632<br>
                <strong>Tokens:</strong> <span id="tokenStatus">Verificando...</span>
            </div>
            <button onclick="verificarTokens()">üîÑ Verificar Tokens</button>
        </div>
        
        <div class="step">
            <h3>üîó Generar URL de emparejamiento</h3>
            <p>Esta URL conectar√° tu aplicaci√≥n Java con el dispositivo:</p>
            <button onclick="generarUrlEmparejamiento()">üöÄ Generar URL de Emparejamiento</button>
            <div id="pairingResult"></div>
        </div>
        
        <div class="step">
            <h3>üì± Configurar Cloud Pay Display</h3>
            <div class="config-box">
                <strong>En tu dispositivo Clover Pocket:</strong><br>
                1. Ve a "More Tools"<br>
                2. Busca "Cloud Pay Display" (NO "REST Pay Display")<br>
                3. Instala Cloud Pay Display si no est√° instalado<br>
                4. Abre Cloud Pay Display<br>
                5. La pantalla deber√≠a mostrar "Waiting for connection"
            </div>
        </div>
        
        <div class="step">
            <h3>üåê Completar emparejamiento</h3>
            <div id="pairingInstructions" style="display: none;">
                <p><strong>Pasos para emparejar:</strong></p>
                <ol>
                    <li>Haz clic en la URL de emparejamiento generada arriba</li>
                    <li>Se abrir√° una nueva pesta√±a con Clover</li>
                    <li>Autoriza la conexi√≥n con el dispositivo</li>
                    <li>El dispositivo deber√≠a cambiar a "Connected"</li>
                    <li>Ejecuta tu aplicaci√≥n Java</li>
                </ol>
                <button onclick="verificarEmparejamiento()">‚úÖ Verificar Emparejamiento</button>
                <div id="pairingStatus"></div>
            </div>
        </div>
        
        <div class="step">
            <h3>üß™ Probar conexi√≥n</h3>
            <p>Una vez emparejado, puedes probar la conexi√≥n:</p>
            <button onclick="probarConexion()">üì° Probar Conexi√≥n WebSocket</button>
            <div id="connectionTest"></div>
        </div>
        
        <div class="step">
            <h3>üìö Informaci√≥n t√©cnica</h3>
            <div class="config-box">
                <strong>WebSocket URL:</strong> wss://ws-sandbox.dev.clover.com/<br>
                <strong>Protocolo:</strong> Remote Pay Cloud<br>
                <strong>Tipo de app:</strong> Web App (existente)<br>
                <strong>Emparejamiento:</strong> Browser-based
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n usando los mismos valores de tu app existente
        const CONFIG = {
            clientId: 'BQA69R3NPK6MC',
            merchantId: '20562DRSEE6T1', 
            deviceSerial: 'C047LG44442632',
            redirectUri: 'https://luisjb.github.io/Clover/callback.html',
            baseUrl: 'https://luisjb.github.io/Clover/'
        };

        function verificarTokens() {
            // Verificar tokens guardados del OAuth
            const accessToken = localStorage.getItem('clover_access_token');
            const refreshToken = localStorage.getItem('clover_refresh_token');
            
            let status = '';
            if (accessToken) {
                status = '‚úÖ Access token disponible';
                if (refreshToken) {
                    status += ', Refresh token disponible';
                }
            } else {
                status = '‚ùå No hay tokens. <a href="index.html" style="color: #4CAF50;">Ve a OAuth Setup</a>';
            }
            
            document.getElementById('tokenStatus').innerHTML = status;
        }

        function generarUrlEmparejamiento() {
            // URL para lanzar la app desde el merchant dashboard
            const pairingUrl = `https://sandbox.dev.clover.com/developer-home/app/${CONFIG.clientId}/merchant/${CONFIG.merchantId}/launch`;
            
            let result = '<div class="success">üîó URL de emparejamiento generada:</div>';
            result += '<div class="config-box">';
            result += `<a href="${pairingUrl}" target="_blank" style="color: #4CAF50; text-decoration: underline; font-size: 16px;">${pairingUrl}</a>`;
            result += '</div>';
            result += '<div class="warning">‚ö†Ô∏è Haz clic en la URL para abrir el proceso de emparejamiento</div>';
            
            document.getElementById('pairingResult').innerHTML = result;
            document.getElementById('pairingInstructions').style.display = 'block';
        }

        function verificarEmparejamiento() {
            document.getElementById('pairingStatus').innerHTML = '<div class="warning">üîÑ Verificando emparejamiento...</div>';
            
            // Simular verificaci√≥n
            setTimeout(() => {
                let result = '<div class="success">üìã Checklist de emparejamiento:</div>';
                result += '<div class="config-box">';
                result += '‚úì URL de emparejamiento visitada<br>';
                result += '‚úì Autorizaci√≥n completada en navegador<br>';
                result += '‚úì Cloud Pay Display corriendo en dispositivo<br>';
                result += '‚úì Dispositivo muestra "Connected" o similar<br>';
                result += '</div>';
                result += '<div class="success">üéâ ¬°Listo para usar con tu aplicaci√≥n Java!</div>';
                
                document.getElementById('pairingStatus').innerHTML = result;
            }, 2000);
        }

        function probarConexion() {
            const accessToken = localStorage.getItem('clover_access_token');
            
            if (!accessToken) {
                document.getElementById('connectionTest').innerHTML = 
                    '<div class="error">‚ùå Necesitas tokens OAuth primero. <a href="index.html" style="color: #f44336;">Ve a OAuth Setup</a></div>';
                return;
            }

            // Mostrar ejemplo de mensaje WebSocket
            const testMessage = {
                method: "DISCOVERY_REQUEST",
                id: "test-" + Date.now(),
                version: 1,
                packageName: "com.luisjb.clover"
            };

            let result = '<div class="success">üì° Mensaje de prueba WebSocket:</div>';
            result += '<div class="config-box">';
            result += 'URL: wss://ws-sandbox.dev.clover.com/<br><br>';
            result += 'Mensaje JSON:<br>';
            result += JSON.stringify(testMessage, null, 2);
            result += '</div>';
            result += '<div class="warning">üí° Env√≠a este mensaje usando tu aplicaci√≥n Java con WebSocket</div>';
            
            document.getElementById('connectionTest').innerHTML = result;
        }

        // Verificar tokens al cargar la p√°gina
        window.onload = function() {
            verificarTokens();
            
            // Si venimos del OAuth callback, mostrar mensaje
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') === 'oauth') {
                document.getElementById('tokenStatus').innerHTML = 'üéâ ¬°Tokens OAuth reci√©n obtenidos! Listo para emparejamiento.';
            }
        };
    </script>
</body>
</html>